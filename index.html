<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과학영재교육원 연간 일정표 (B4 레이아웃)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 2vw;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden; 
        }

        .printable-area {
            width: 90vw;
            max-width: 943px;
            aspect-ratio: 943 / 670;
            overflow: hidden;
            font-size: 1.1vw;
            display: flex;
            flex-direction: column;
            margin: 1em auto;
            padding: 2em;
            background-color: #ffffff;
            box-shadow: 0 0.4em 1.2em rgba(0,0,0,0.1);
            border-radius: 0.8em;
            box-sizing: border-box;
        }
        
        @media (min-width: 1050px) {
            .printable-area {
                font-size: 10px;
            }
        }

        .title-container {
            flex-shrink: 0; 
            background-color: #f0f0f0;
            border-radius: 1.5em;
            padding: 1.5em 2em;
            margin-bottom: 1.5em;
            text-align: center;
        }

        .title-container h1 {
            font-size: 1.8em;
            color: #2c3e50;
            margin: 0 0 0.5em 0;
        }
        
        .title-container h2 {
            font-size: 1.2em;
            color: #555;
            margin: 0;
        }
        
        .grid-table {
            flex-grow: 1;
            display: grid;
            gap: 0.2em;
        }

        .grid-cell {
            background-color: #f8f9fa;
            border-radius: 0.6em;
            padding: 0.1em;
            text-align: center;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            line-height: 1.3;
            word-break: break-all;
        }

        .grid-header {
            background-color: #e9ecef;
            color: #333;
            font-weight: bold;
        }

        .date-cell {
             font-weight: bold;
             background-color: #e9ecef;
        }
        
        .content-specific-style {
            font-size: 0.65em;
            padding: 0.1em 0;
            line-height: 1.15;
        }
        
        .color-1 { background-color: #e9d8fd; color: #3c2a62; }
        .color-2 { background-color: #d4edda; color: #155724; }
        .color-3 { background-color: #ffe8cc; color: #664d03; }
        .color-4 { background-color: #f8d7da; color: #721c24; }
        .color-5 { background-color: #fff3cd; color: #664d03; }
        
        .pdf-btn-container { text-align: center; margin: 40px auto; }
        .pdf-btn { background-color: #007bff; color: white; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer; }
        .pdf-btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <div id="pdf-content">
        <div class="printable-area" id="semester-1-area">
            <div class="title-container">
                <h1 class="main-title">2025학년도 서울교육대학교 과학영재교육원 연간 일정표</h1>
                <h2>1학기 교육일정</h2>
            </div>
            <div id="schedule-grid-1" class="grid-table"></div>
        </div>
        <div class="printable-area" id="semester-2-area">
            <div class="title-container">
                <h1 class="main-title">2025학년도 서울교육대학교 과학영재교육원 연간 일정표</h1>
                <h2>2학기 교육일정</h2>
            </div>
            <div id="schedule-grid-2" class="grid-table"></div>
        </div>
    </div>
    
    <div class="pdf-btn-container">
        <button id="save-pdf-btn" class="pdf-btn">전체 시간표 PDF로 저장하기</button>
    </div>
</div>

<script>
    const googleSheetURL_1 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTrFwmv2T8vOgcXWDadPZ15ddd6VLAqzQ_VSg5Cw9O8aecpom1Lr_wuImNogCYY3FxqwYJgIPhfAmrF/pub?gid=0&single=true&output=csv';
    const googleSheetURL_2 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTrFwmv2T8vOgcXWDadPZ15ddd6VLAqzQ_VSg5Cw9O8aecpom1Lr_wuImNogCYY3FxqwYJgIPhfAmrF/pub?gid=977776868&single=true&output=csv';

    function parseCSV(csvText) {
        const lines = csvText.trim().replace(/\r/g, '').split('\n');
        return lines.map(line => line.split(',').map(cell => cell.trim()));
    }

    function populateGrid(gridContainerId, allRows) {
        console.log("✅ [최종 수정 버전] 헤더 줄바꿈 코드가 실행 중입니다.");

        try {
            if (allRows.length > 0 && allRows[0].length > 16) {
                const newTitle = allRows[0][16]; 
                if (newTitle && newTitle.trim() !== '') {
                    document.querySelectorAll('.main-title').forEach(titleElement => {
                        titleElement.textContent = newTitle;
                    });
                }
            }
        } catch (e) {
            console.error("제목을 설정하는 중 오류가 발생했습니다.", e);
        }

        const displayRows = allRows.map(row => row.slice(0, 16));
        const gridContainer = document.getElementById(gridContainerId);
        gridContainer.innerHTML = '';

        if (displayRows.length < 2) return;
        const numColumns = displayRows[0].length;
        
        let columnTemplates = Array(numColumns).fill('1fr');
        if (numColumns > 2) {
            columnTemplates[0] = '70px'; 
            columnTemplates[1] = '60px'; 
            columnTemplates[2] = '200px';
        }
        gridContainer.style.gridTemplateColumns = columnTemplates.join(' ');

        const headerRows = displayRows.slice(0, 2);
        const [row1, row2] = headerRows;
        
        // 헤더 생성
        for (let i = 0; i < numColumns; i++) {
            const div = document.createElement('div');
            div.className = 'grid-cell grid-header';
            
            // 1행의 내용에서 ||를 찾아 줄바꿈을 적용합니다.
            let content = (row1[i] || '').replace(/\s*\|\|\s*|\s*\/\/\s*/g, '<br>');

            // 2행의 내용은 작은 글씨의 부제목으로 아래에 추가됩니다.
            if (row2 && row2[i] && row2[i].trim() !== '') {
                content += `<br><span style="font-size: 0.9em; font-weight: normal;">${row2[i]}</span>`;
            }
            div.innerHTML = content;
            gridContainer.appendChild(div);
        }

        const bodyRows = displayRows.slice(2);
        const processedBodyRows = JSON.parse(JSON.stringify(bodyRows));

        for (let i = 0; i < processedBodyRows.length; i++) {
            if (processedBodyRows[i][0] === null) continue;
            let rowspan = 1;
            for (let j = i + 1; j < processedBodyRows.length; j++) {
                if (processedBodyRows[j][0] === '') {
                    rowspan++;
                    processedBodyRows[j][0] = null;
                } else { break; }
            }
            processedBodyRows[i][0] = { content: processedBodyRows[i][0], rowspan: rowspan };
        }
        
        processedBodyRows.forEach((row) => {
             for (let i = 0; i < row.length; i++) {
                if (row[i] === null) continue;
                let colspan = 1;
                for (let j = i + 1; j < row.length; j++) {
                    if (row[j] === '') { colspan++; } else { break; }
                }
                const div = document.createElement('div');
                div.className = 'grid-cell';

                if (i >= 3) {
                    div.classList.add('content-specific-style');
                }

                const setCellContent = (element, contentString) => {
                    let finalContent = contentString;
                    if (typeof contentString === 'string') {
                        if (contentString.trim() === '**') {
                            element.innerHTML = '';
                            return;
                        }

                        const colorMatch = finalContent.match(/\[c(\d+)\]/);
                        if (colorMatch) {
                            const colorClass = `color-${colorMatch[1]}`;
                            element.classList.add(colorClass);
                            finalContent = finalContent.replace(/\[c\d+\]/, '').trim();
                        }
                        
                        element.innerHTML = finalContent.replace(/\s*\|\|\s*|\s*\/\/\s*/g, '<br>');

                    } else if (contentString) {
                        element.innerHTML = contentString;
                    }
                };

                if (i === 0 && typeof row[i] === 'object') {
                    setCellContent(div, row[i].content);
                    div.classList.add('date-cell');
                    if (row[i].rowspan > 1) {
                        div.style.gridRow = `span ${row[i].rowspan}`;
                    }
                } else {
                    setCellContent(div, row[i]);
                }
                
                if (colspan > 1) {
                    div.style.gridColumn = `span ${colspan}`;
                    for (let k = 1; k < colspan; k++) { row[i + k] = null; }
                }
                gridContainer.appendChild(div);
            }
        });
    }

    function loadAndDisplaySheet(url, gridId) {
        fetch(url)
            .then(res => res.ok ? res.text() : Promise.reject(`Error: ${res.statusText}`))
            .then(csv => populateGrid(gridId, parseCSV(csv)))
            .catch(err => {
                console.error('Data loading error:', err);
                document.getElementById(gridId).innerHTML = `<div class="grid-cell" style="grid-column: 1 / -1; color: red;"><b>오류:</b> 데이터를 불러올 수 없습니다.</div>`;
            });
    }

    window.onload = function() {
        loadAndDisplaySheet(googleSheetURL_1, 'schedule-grid-1');
        loadAndDisplaySheet(googleSheetURL_2, 'schedule-grid-2');
    };
    
    document.getElementById('save-pdf-btn').addEventListener('click', () => {
        const opt = {
            margin: 0.5,
            filename: '2025_과학영재원_연간일정표_B4.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'b4', orientation: 'landscape' }
        };
        const content = document.getElementById('pdf-content');
        html2pdf().from(content).set(opt).save();
    });
</script>

</body>
</html>
